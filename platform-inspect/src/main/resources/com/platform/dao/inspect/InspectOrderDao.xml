<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.dao.inspect.InspectOrderDao">

    <resultMap type="com.platform.entity.inspect.InspectOrderEntity" id="inspectOrderMap">
        <result property="id" column="id"/>
        <result property="materialId" column="material_id"/>
        <result property="regionId" column="region_id"/>
        <result property="status" column="status"/>
        <result property="inspectTime" column="inspect_time"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="inspectStatus" column="inspect_status"/>
        <result property="chiefIds" column="chief_ids"/>
        <result property="chiefName" column="chief_name"/>
        <result property="photos" column="photos"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="dataStatus" column="data_status"/>
    </resultMap>

	<select id="queryObject" resultType="com.platform.entity.inspect.InspectOrderEntity">
		select
			`id`,
			`material_id`,
			`region_id`,
			`status`,
			`inspect_time`,
			`user_id`,
			`user_name`,
			`inspect_status`,
			`chief_ids`,
			`chief_name`,
			`photos`,
			`create_time`,
			`update_time`,
			`data_status`
		from inspect_order
		where id = #{id}
	</select>

	<select id="queryList" resultType="com.platform.entity.inspect.InspectOrderEntity">
		SELECT
			o.id,
			o.material_id,
			o.region_id,
			o.`status`,
			o.inspect_time,
			o.user_id,
			o.user_name,
			o.inspect_status,
			o.description,
			o.chief_ids,
			o.chief_name,
			o.photos,
			o.create_time,
			o.update_time,
			o.data_status,
			m.material_name AS materialName
		FROM
		inspect_order AS o
		LEFT JOIN material AS m ON m.id = o.material_id
		WHERE 1=1
		<if test="materialName != null and materialName.trim() != ''">
			AND m.material_name LIKE concat('%',#{materialName},'%')
		</if>
		<if test="status != null">
			AND o.`status` = #{status}
		</if>
		<if test="inspectStatus != null">
			AND o.`inspect_status` = #{inspectStatus}
		</if>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
			<otherwise>
                order by id desc
			</otherwise>
        </choose>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>

	<!-- APP异常接口 -->
	<select id="search" resultType="com.platform.entity.inspect.vo.AnomalyVo">
		SELECT
		o.id,m.id as materialId,m.qr_code AS qrCode,m.material_name AS materialName,m.location,o.inspect_time AS checkTime,
		(CASE WHEN o.inspect_status=0 THEN '正常' ELSE '异常' END) AS checkResult,o.description,o.user_name AS checkUserName,
		m.material_url AS materialUrl,m.produced_date AS producedDate,m.expire_date AS expireDate,
		o.chief_ids AS chiefIds,m.material_type_id AS materialTypeId,o.photos as urls
		FROM inspect_order o
		LEFT JOIN material m ON m.id = o.material_id
		WHERE o.inspect_status=1
		<if test="status != null and status != ''">
			AND o.status = #{status}
		</if>
		<if test="materialId != null and materialId != ''">
			AND m.id=#{materialId}
		</if>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
		ORDER BY o.id DESC
	</select>
	
 	<select id="queryTotal" resultType="int">
		SELECT count(1)
		FROM inspect_order AS o
		LEFT JOIN material AS m ON m.id = o.material_id
		WHERE o.inspect_status=1 AND o.status = #{status}
		<if test="materialName != null and materialName.trim() != ''">
			AND m.material_name LIKE concat('%',#{materialName},'%')
		</if>
	</select>

	<select id="searchTotal" resultType="int">
		select count(1)
		FROM inspect_order o
		LEFT JOIN material m ON m.id = o.material_id
		WHERE o.inspect_status=#{inspectStatus}
	</select>

	<!-- 异常工单统计 -->
	<select id="statExceptionOrder" resultType="com.platform.entity.dto.StatDto">
		SELECT
		region_id,
		`status` AS `status`,
		COUNT(*) AS num
		FROM
		inspect_order
		WHERE 1 = 1
		AND  inspect_status = 1
		<if test="status != null">
			AND status =#{status}
		</if>
		<if test="startTime != null and endTime != null">
			<![CDATA[	AND #{startTime} <= `update_time` AND  `update_time`<= #{endTime}  ]]>
		</if>
		<if test="regionIdList != null">
			AND region_id IN
			<foreach collection="regionIdList" item="regionId" index="index" open="(" close=")" separator=",">
				#{regionId}
			</foreach>
		</if>
		GROUP BY  region_id,`status`
	</select>
	 
	<insert id="save" parameterType="com.platform.entity.inspect.InspectOrderEntity" useGeneratedKeys="true" keyProperty="id">
		insert into inspect_order(
			`material_id`,
			`region_id`,
			`status`,
			`inspect_time`,
			`user_id`,
			`user_name`,
			`inspect_status`,
			`chief_ids`,
			`chief_name`,
			`photos`,
			`create_time`,
			`update_time`,
			`data_status`)
		values(
			#{materialId},
			#{regionId},
			#{status},
			#{inspectTime},
			#{userId},
			#{userName},
			#{inspectStatus},
			#{chiefIds},
			#{chiefName},
			#{photos},
			#{createTime},
			#{updateTime},
			#{dataStatus})
	</insert>
	 
	<update id="update" parameterType="com.platform.entity.inspect.InspectOrderEntity">
		update inspect_order 
		<set>
			<if test="materialId != null">`material_id` = #{materialId}, </if>
			<if test="regionId != null">`region_id` = #{regionId}, </if>
			<if test="status != null">`status` = #{status}, </if>
			<if test="inspectTime != null">`inspect_time` = #{inspectTime}, </if>
			<if test="userId != null">`user_id` = #{userId}, </if>
			<if test="userName != null">`user_name` = #{userName}, </if>
			<if test="inspectStatus != null">`inspect_status` = #{inspectStatus}, </if>
			<if test="chiefIds != null">`chief_ids` = #{chiefIds}, </if>
			<if test="chiefName != null">`chief_name` = #{chiefName}, </if>
			<if test="photos != null">`photos` = #{photos}, </if>
			<if test="createTime != null">`create_time` = #{createTime}, </if>
			<if test="updateTime != null">`update_time` = #{updateTime}, </if>
			<if test="dataStatus != null">`data_status` = #{dataStatus}</if>
			<if test="description != null">`description` = #{description}</if>
		</set>
		where id = #{id}
	</update>
	
	<delete id="delete">
		delete from inspect_order where id = #{value}
	</delete>
	
	<delete id="deleteBatch">
		delete from inspect_order where id in 
		<foreach item="id" collection="array" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>

	<select id="selectMaterialInspectHistory" resultType="com.platform.entity.material.MaterialVo">

	</select>

</mapper>