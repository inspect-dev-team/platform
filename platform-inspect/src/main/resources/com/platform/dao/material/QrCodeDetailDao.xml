<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.dao.material.QrCodeDetailDao">

    <resultMap type="com.platform.entity.material.QrCodeDetailEntity" id="qrCodeDetailMap">
        <result property="id" column="id"/>
        <result property="applyId" column="apply_id"/>
        <result property="matetialId" column="matetial_id"/>
        <result property="materialTypeId" column="material_type_id"/>
        <result property="bindUserId" column="bind_user_id"/>
        <result property="bindTime" column="bind_time"/>
		<result property="qrCode" column="qr_code"/>
		<result property="idCode" column="id_code"/>
    </resultMap>

	<select id="queryObject" resultType="com.platform.entity.material.QrCodeDetailEntity">
		select
			`id`,
			`apply_id`,
			`matetial_id`,
			`material_type_id`,
			`bind_user_id`,
			`bind_time`,
			qr_code,
			id_code
		from qr_code_detail
		where id = #{id}
	</select>


	<select id="selectQrCodeDetails" resultType="com.platform.entity.material.QrCodeDetailEntity">
		SELECT
			d.id AS id,
			d.qr_code AS qrCode,
			d.apply_id AS applyId,
			d.matetial_id AS matetialId,
			d.material_type_id AS materialTypeId,
			d.bind_user_id AS bindUserId,
			d.bind_time AS bindTime,
		    d.id_code AS idCode,
			t.batch_no AS batchNo,
			t.generate_date AS generateTime,
			t.realname AS generateUserName,
			su.realname AS bindUserName,
			m.material_name AS matetialName,
			mt.`name` AS materialTypeName
		FROM
		qr_code_detail AS d
		LEFT JOIN (
			SELECT
				a.id,
				a.batch_no,
				a.generate_date,
				u.realname
			FROM
			qr_code_apply AS a
			LEFT JOIN sys_user AS u ON a.generate_man = u.user_id
		) AS t ON d.apply_id = t.id
		LEFT JOIN sys_user AS su ON d.bind_user_id = su.user_id
		LEFT JOIN material AS m ON m.id = d.matetial_id
		LEFT JOIN material_type AS mt ON mt.id = d.material_type_id
		WHERE 1=1
		<if test="applyId != null">
			AND d.apply_id = #{applyId}
		</if>
		<choose>
			<when test="sidx != null and sidx.trim() != ''">
				order by ${sidx} ${order}
			</when>
			<otherwise>
				order by id desc
			</otherwise>
		</choose>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>

	<select id="selectQrCodeDetailsTotal" resultType="int">
		SELECT
		    COUNT(*)
		FROM
		qr_code_detail AS d
		LEFT JOIN (
		SELECT
		a.id,
		a.batch_no,
		a.generate_date,
		u.realname
		FROM
		qr_code_apply AS a
		LEFT JOIN sys_user AS u ON a.generate_man = u.user_id
		) AS t ON d.apply_id = t.id
		LEFT JOIN sys_user AS su ON d.bind_user_id = su.user_id
		LEFT JOIN material AS m ON m.id = d.matetial_id
		LEFT JOIN material_type AS mt ON mt.id = d.material_type_id
		WHERE 1=1
		<if test="applyId != null">
			AND d.apply_id = #{applyId}
		</if>
	</select>

	<select id="queryList" resultType="com.platform.entity.material.QrCodeDetailEntity">
		select
    		`id`,
    		`apply_id`,
    		`matetial_id`,
    		`material_type_id`,
    		`bind_user_id`,
    		`bind_time`,
		     qr_code,
		     id_code
		from qr_code_detail
		WHERE 1=1
		<if test="name != null and name.trim() != ''">
			AND name LIKE concat('%',#{name},'%')
		</if>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
			<otherwise>
                order by id desc
			</otherwise>
        </choose>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	
 	<select id="queryTotal" resultType="int">
		select count(*) from qr_code_detail
		WHERE 1=1
        <if test="name != null and name.trim() != ''">
            AND name LIKE concat('%',#{name},'%')
        </if>
	</select>
	 
	<insert id="save" parameterType="com.platform.entity.material.QrCodeDetailEntity" useGeneratedKeys="true" keyProperty="id">
		insert into qr_code_detail(
			`apply_id`,
			`matetial_id`,
			`material_type_id`,
			`bind_user_id`,
			`bind_time`,
			qr_code,id_code)
		values(
			#{applyId},
			#{matetialId},
			#{materialTypeId},
			#{bindUserId},
			#{bindTime},
			#{qrCode},
			#{idCode}
			)
	</insert>
	 
	<update id="update" parameterType="com.platform.entity.material.QrCodeDetailEntity">
		update qr_code_detail 
		<set>
			<if test="applyId != null">`apply_id` = #{applyId}, </if>
			<if test="matetialId != null">`matetial_id` = #{matetialId}, </if>
			<if test="materialTypeId != null">`material_type_id` = #{materialTypeId}, </if>
			<if test="bindUserId != null">`bind_user_id` = #{bindUserId}, </if>
			<if test="qrCode != null">`qr_code` = #{qrCode}, </if>
			<if test="idCode != null">`id_code` = #{idCode}, </if>
			<if test="bindTime != null">`bind_time` = #{bindTime}</if>
		</set>
		where id = #{id}
	</update>
	
	<delete id="delete">
		delete from qr_code_detail where id = #{value}
	</delete>
	
	<delete id="deleteBatch">
		delete from qr_code_detail where id in 
		<foreach item="id" collection="array" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>

</mapper>